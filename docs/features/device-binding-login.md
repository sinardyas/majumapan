# Feature Specification: Device Binding Login System

## Status

**Implemented** - All phases complete

> **Business Context**: See [Device Binding Login System PRD](../prd/device-binding-login-system.md) for product requirements, user personas, goals, and success metrics. This document covers technical implementation details.

## Overview

A simplified POS login system using device binding via QR code or 6-character code. The system replaces email/password authentication with a two-step process:

1. **Device Binding** - Store Manager binds POS device to store using QR code or 6-character code (one-time setup)
2. **User Authentication** - Cashier/Store Manager selects their profile and enters 6-digit PIN to operate POS

Each POS device is bound to exactly one store (1:1 relationship), and each user belongs to exactly one store with a specific role (Manager or Cashier).

## Use Case

**Scenario 1: First-Time Device Setup (Store Manager)**

1. Admin creates a device in Admin Portal, generates QR code and 6-char code
2. Store Manager opens POS app on new tablet
3. Manager scans QR code or enters 6-char code manually
4. Device binds to store â†’ User selection screen appears
5. Manager selects their profile â†’ Enters PIN â†’ Authenticated

**Scenario 2: Daily Login (Cashier)**

1. Cashier opens POS app
2. Device already bound â†’ User selection screen shows
3. Cashier taps their profile â†’ Enters 6-digit PIN
4. Authenticated â†’ POS dashboard loads

**Scenario 3: Device Revocation (Admin)**

1. Admin opens Admin Portal â†’ Devices menu
2. Clicks "Revoke" on a device
3. All active sessions on that device immediately invalidated
4. POS shows "Device access revoked" message

## Requirements

| Requirement | Decision |
|-------------|----------|
| Login Methods | QR Code Scan + 6-char Manual Entry |
| PIN Length | 6 digits |
| PIN Lockout | 15 minutes after 5 failed attempts |
| Shift Flow | Separate from PIN login (per PRD) |
| User Avatar | Initials only (no photos) |
| Profile Selection | Tap to select (no quick numbers) |
| Device Name | Auto-generated by system (POS-[RandomID]) |
| Binding Expiration | 24 hours for unused codes |
| Session Timeout | 30 minutes of inactivity |
| JWT Expiry | 8 hours for access token |
| Refresh Token | 7 days, bcrypt hashed |

## Data Model

### DeviceBinding Interface

```typescript
// packages/shared/src/types.ts

export interface DeviceBinding {
  id: string;
  storeId: string;
  storeName?: string;
  deviceId: string | null;
  bindingCode: string;
  qrData: string;
  status: 'pending' | 'active' | 'revoked';
  deviceName: string;
  deviceFingerprint: string | null;
  boundAt: string | null;
  expiresAt: string | null;
  revokedAt: string | null;
  revokedBy: string | null;
  revokedReason: string | null;
  createdAt: string;
  updatedAt: string;
}
```

### UserSession Interface

```typescript
// packages/shared/src/types.ts

export interface UserSession {
  id: string;
  userId: string;
  userName?: string;
  deviceId: string;
  storeId: string;
  isActive: boolean;
  pinFailedAttempts: number;
  pinLockedUntil: string | null;
  lastActiveAt: string | null;
  lastPinAt: string | null;
  createdAt: string;
  endedAt: string | null;
}
```

### User Interface (Updates)

```typescript
// packages/shared/src/types.ts - additions to existing User type

export interface User {
  // ... existing fields
  pin: string | null;        // bcrypt hashed, 6-digit PIN
  role: 'manager' | 'cashier';
  storeId: string;
}
```

### Device Interface (Updates)

```typescript
// packages/shared/src/types.ts - additions to existing Device type

export interface Device {
  // ... existing fields
  bindingId: string | null;
  lastActiveAt: string | null;
  isMasterTerminal: boolean;
}
```

### Database Schema (Drizzle)

```typescript
// apps/api/src/db/schema.ts

import { pgTable, uuid, timestamp, text, varchar, boolean, integer, index, uniqueIndex } from 'drizzle-orm/pg-core';
import { stores } from './stores';
import { users } from './users';

export const deviceBindings = pgTable('device_bindings', {
  id: uuid('id').primaryKey().defaultRandom(),
  storeId: uuid('store_id').notNull().references(() => stores.id),
  deviceId: uuid('device_id'),
  bindingCode: varchar('binding_code', { length: 6 }).notNull().unique(),
  qrData: text('qr_data').notNull(),
  status: varchar('status', { length: 20 }).notNull().default('pending'),
  deviceName: varchar('device_name').notNull(),
  deviceFingerprint: text('device_fingerprint'),
  boundAt: timestamp('bound_at'),
  expiresAt: timestamp('expires_at'),
  revokedAt: timestamp('revoked_at'),
  revokedBy: uuid('revoked_by').references(() => users.id),
  revokedReason: text('revoked_reason'),
  createdAt: timestamp('created_at').notNull().defaultNow(),
  updatedAt: timestamp('updated_at').notNull().defaultNow(),
}, (table) => [
  index('device_bindings_store_idx').on(table.storeId),
  index('device_bindings_status_idx').on(table.status),
  index('device_bindings_binding_code_idx').on(table.bindingCode),
]);

export const userSessions = pgTable('user_sessions', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').notNull().references(() => users.id),
  deviceId: uuid('device_id').notNull(),
  storeId: uuid('store_id').notNull(),
  pinHash: varchar('pin_hash').notNull(),
  isActive: boolean('is_active').notNull().default(true),
  pinFailedAttempts: integer('pin_failed_attempts').notNull().default(0),
  pinLockedUntil: timestamp('pin_locked_until'),
  lastActiveAt: timestamp('last_active_at'),
  lastPinAt: timestamp('last_pin_at'),
  createdAt: timestamp('created_at').notNull().defaultNow(),
  endedAt: timestamp('ended_at'),
}, (table) => [
  index('user_sessions_user_idx').on(table.userId),
  index('user_sessions_device_idx').on(table.deviceId),
  index('user_sessions_is_active_idx').on(table.isActive),
]);
```

### Users Table Updates

```sql
-- apps/api/drizzle/000X_device_binding_auth.sql

ALTER TABLE users 
ADD COLUMN IF NOT EXISTS pin VARCHAR(60),
ADD COLUMN IF NOT EXISTS role VARCHAR(20) NOT NULL DEFAULT 'cashier',
ADD COLUMN IF NOT EXISTS store_id UUID REFERENCES stores(id);

ALTER TABLE devices 
ADD COLUMN IF NOT EXISTS binding_id UUID REFERENCES device_bindings(id),
ADD COLUMN IF NOT EXISTS last_active_at TIMESTAMP,
ADD COLUMN IF NOT EXISTS is_master_terminal BOOLEAN NOT NULL DEFAULT false;
```

## API Types

```typescript
// packages/api/src/types.ts

export interface DeviceApi {
  // Admin endpoints
  listDevices(filters?: {
    storeId?: string;
    status?: 'pending' | 'active' | 'revoked';
    search?: string;
  }): Promise<{ devices: DeviceBinding[] }>;

  createDevice(data: {
    storeId: string;
    expiresIn?: 'never' | '24h' | '7d' | '30d';
  }): Promise<{
    device: DeviceBinding;
    qrCode: string;
  }>;

  getDevice(deviceId: string): Promise<{ device: DeviceBinding }>;

  revokeDevice(deviceId: string, reason?: string): Promise<{ success: boolean }>;

  regenerateCode(deviceId: string): Promise<{
    device: DeviceBinding;
    qrCode: string;
  }>;

  getQrCode(deviceId: string): Promise<{ qrCode: string }>;

  // Store-scoped endpoints (manager)
  listStoreDevices(storeId: string): Promise<{ devices: DeviceBinding[] }>;

  createStoreDevice(storeId: string, data: {
    expiresIn?: 'never' | '24h' | '7d' | '30d';
  }): Promise<{ device: DeviceBinding; qrCode: string }>;

  revokeStoreDevice(storeId: string, deviceId: string, reason?: string): Promise<{ success: boolean }>;
}

export interface AuthApi {
  // Device login (public)
  deviceLogin(data: {
    bindingCode: string;
    deviceFingerprint?: string;
  }): Promise<{
    device: {
      id: string;
      storeId: string;
      deviceName: string;
      storeName: string;
    };
    users: Array<{
      id: string;
      name: string;
      role: 'manager' | 'cashier';
      lastLoginAt?: string;
    }>;
  }>;

  // PIN login (device authenticated)
  pinLogin(data: {
    userId: string;
    pin: string;
  }): Promise<{
    user: {
      id: string;
      name: string;
      role: 'manager' | 'cashier';
      storeId: string;
    };
    accessToken: string;
    refreshToken: string;
  }>;

  // Device authenticated
  getCurrentDevice(): Promise<{ device: DeviceBinding }>;

  listDeviceUsers(): Promise<{
    users: Array<{
      id: string;
      name: string;
      role: 'manager' | 'cashier';
      lastLoginAt?: string;
    }>;
  }>;

  logout(): Promise<{ success: boolean }>;

  getCurrentUser(): Promise<{ user: User }>;

  switchUser(userId: string, pin: string): Promise<{
    user: User;
    accessToken: string;
  }>;
}

export interface UserManagementApi {
  // Store-scoped user management
  listStoreUsers(storeId: string): Promise<{ users: User[] }>;

  createStoreUser(storeId: string, data: {
    name: string;
    email: string;
    password: string;
    role: 'manager' | 'cashier';
    pin?: string;
  }): Promise<{ user: User }>;

  updateStoreUser(storeId: string, userId: string, data: {
    name?: string;
    role?: 'manager' | 'cashier';
  }): Promise<{ user: User }>;

  resetUserPin(storeId: string, userId: string): Promise<{ success: boolean }>;

  setUserPin(storeId: string, userId: string, pin: string): Promise<{ success: boolean }>;

  getUserSessions(userId: string): Promise<{ sessions: UserSession[] }>;
}
```

## User Flows

### Flow 1: Admin Creates Device

```
1. Admin logs into Admin Portal
2. Navigates to Devices Menu or Store â†’ Devices Tab
3. Clicks "Create Device"
4. Selects Store (Manager: limited to own store)
5. Selects Expiration (default: 24 hours)
6. System auto-generates:
   - Device Name: "POS-A7X9K2"
   - Binding Code: "X7K9P2"
   - QR Code
7. Admin views/copies code or downloads QR
8. Admin shares code/QR with Store Manager
```

### Flow 2: Store Manager Binds Device

```
1. Manager opens POS app on new device
2. POS shows device login screen
3. Manager chooses method:
   Option A: Scan QR Code
   - Camera opens
   - Manager scans QR from admin portal
   Option B: Enter Code Manually
   - Manager types "X7K9P2"
4. System validates code
5. Device binds to store
6. POS shows "Device Setup Complete"
7. Manager taps "Continue" â†’ User selection screen
8. Manager selects their profile
9. Enters PIN â†’ Authenticated
10. POS dashboard loads
```

### Flow 3: Cashier Daily Login

```
1. Cashier opens POS app
2. POS shows user selection screen (device already bound)
3. Cashier taps their profile
4. PIN entry screen appears
5. Cashier enters 6-digit PIN
6. Authenticated
7. POS dashboard loads with cashier's permissions
```

### Flow 4: Admin Revokes Device

```
1. Admin opens Admin Portal
2. Navigates to Devices Menu
3. Finds target device
4. Clicks "Revoke"
5. Confirms in modal (optional: reason)
6. System updates status to "revoked"
7. All active sessions on device invalidated
8. POS device shows "Access Revoked" message
```

### Flow 5: User Switch

```
1. Authenticated Cashier is using POS
2. Cashier taps user avatar in header
3. Selects "Switch User"
4. Current session deactivated
5. User selection screen appears
6. New user selects profile
7. Enters PIN
8. New session activated
```

## User Interface

### DeviceLoginScreen (POS)

```
Props:
- onDeviceBound: (device: DeviceBinding, users: User[]) => void

Layout:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Majumapan POS                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  [ ðŸ“· Scan QR Code ]     [ âŒ¨ï¸ Enter Code Manually ]     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚                                                                 â”‚
â”‚  QR SCAN MODE (default if camera available):                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚              [ Camera Viewfinder ]                      â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚              Point camera at QR code                    â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚           [ Switch to Manual Entry ]                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  MANUAL ENTRY MODE:                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚   Enter 6-character code:                              â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚   â”‚                                                 â”‚  â”‚   â”‚
â”‚  â”‚   â”‚           X  X  X  X  X  X                      â”‚  â”‚   â”‚
â”‚  â”‚   â”‚                                                 â”‚  â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚   [ Switch to QR Scan ]                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  [ Connect Device ]                                           â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### UserSelectionScreen (POS)

```
Props:
- users: User[]
- onSelectUser: (userId: string) => void
- onSwitchDevice: () => void

Layout:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Majumapan POS                     [Switch Device]      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  Store: Main Branch                                            â”‚
â”‚  Device: POS-A7X9K2                                           â”‚
â”‚                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚                                                                 â”‚
â”‚  Select Your Profile:                                          â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚   â”‚
â”‚  â”‚  â”‚  ðŸ‘¤ Budi    â”‚  Store Manager                           â”‚   â”‚
â”‚  â”‚  â”‚             â”‚  Last login: Today, 8:30 AM              â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚   â”‚
â”‚  â”‚  â”‚  ðŸ‘¤ Sari    â”‚  Cashier                                 â”‚   â”‚
â”‚  â”‚  â”‚             â”‚  Last login: Today, 9:15 AM              â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### PinEntryScreen (POS)

```
Props:
- user: User
- onSubmit: (pin: string) => Promise<void>
- onForgotPin: () => void

State:
- pin: string (6 digits)
- error: string | null
- isLoading: boolean

Layout:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ðŸ‘¤ Budi                                                  â”‚   â”‚
â”‚  â”‚  Store Manager                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  Enter your PIN:                                               â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚           â—  â—  â—  â—  â—  â—                              â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”                                               â”‚
â”‚  â”‚ 1 â”‚ 2 â”‚ 3 â”‚                                               â”‚
â”‚  â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤                                               â”‚
â”‚  â”‚ 4 â”‚ 5 â”‚ 6 â”‚                                               â”‚
â”‚  â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤                                               â”‚
â”‚  â”‚ 7 â”‚ 8 â”‚ 9 â”‚                                               â”‚
â”‚  â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤                                               â”‚
â”‚  â”‚ â† â”‚ 0 â”‚ âœ“ â”‚                                               â”‚
â”‚  â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜                                               â”‚
â”‚                                                                 â”‚
â”‚  [Forgot PIN? Contact admin]                                   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Admin: DeviceListPage

```
Route: /devices

Columns:
| Store | Device Name | Binding Code | Status | Bound At | Last Active | Actions |

Actions:
- View (opens details panel)
- Revoke (confirmation modal)
- Regenerate Code
```

### Admin: CreateDeviceModal

```
Props:
- isOpen: boolean
- onClose: () => void
- onSuccess: (device: DeviceBinding) => void

Fields:
| Field | Type | Default |
|-------|------|---------|
| Store | Dropdown | - |
| Expiration | Dropdown | 24h |

Auto-generated (read-only):
- Device Name: "POS-A7X9K2"
- Binding Code: "X7K9P2"
- QR Code preview

Actions:
- Copy binding code
- Download QR code
```

### Admin: DeviceDetailsPanel

```
Sections:
- Header: Device name, ID, status badge
- Binding Info: Store, Binding code, QR code, Created at, Expires at
- Activity: Bound at, Last active at
- Session History: List of user sessions with timestamps
- Actions: Revoke, Regenerate Code, Download QR
```

## API Endpoints

### Public Endpoints

#### POST /api/v1/auth/device-login

Request:
```json
{
  "bindingCode": "X7K9P2",
  "deviceFingerprint": "abc123..."
}
```

Response (200):
```json
{
  "success": true,
  "data": {
    "device": {
      "id": "uuid",
      "storeId": "uuid",
      "deviceName": "POS-A7X9K2",
      "storeName": "Main Branch"
    },
    "users": [
      {
        "id": "uuid",
        "name": "Budi",
        "role": "manager",
        "lastLoginAt": "2026-02-14T08:30:00Z"
      },
      {
        "id": "uuid",
        "name": "Sari",
        "role": "cashier",
        "lastLoginAt": "2026-02-14T09:15:00Z"
      }
    ]
  }
}
```

Response (400 - Errors):
```json
{
  "success": false,
  "error": {
    "code": "CODE_NOT_FOUND",
    "message": "Invalid binding code. Please check and try again."
  }
}
```

#### POST /api/v1/auth/pin-login

Request:
```json
{
  "userId": "uuid",
  "pin": "123456"
}
```

Response (200):
```json
{
  "success": true,
  "data": {
    "user": {
      "id": "uuid",
      "name": "Budi",
      "role": "manager",
      "storeId": "uuid"
    },
    "accessToken": "eyJhbG...",
    "refreshToken": "eyJhbG..."
  }
}
```

### Admin Endpoints

#### GET /api/v1/admin/devices

Query params: `?storeId=uuid&status=active&search=POS`

Response (200):
```json
{
  "devices": [
    {
      "id": "uuid",
      "storeId": "uuid",
      "storeName": "Main Branch",
      "deviceName": "POS-A7X9K2",
      "bindingCode": "X7K9P2",
      "status": "active",
      "boundAt": "2026-02-13T10:00:00Z",
      "lastActiveAt": "2026-02-14T09:00:00Z"
    }
  ]
}
```

#### POST /api/v1/admin/devices

Request:
```json
{
  "storeId": "uuid",
  "expiresIn": "24h"
}
```

Response (200):
```json
{
  "device": {
    "id": "uuid",
    "deviceName": "POS-A7X9K2",
    "bindingCode": "X7K9P2",
    "status": "pending",
    "expiresAt": "2026-02-14T10:00:00Z"
  },
  "qrCode": "data:image/png;base64,..."
}
```

#### PUT /api/v1/admin/devices/:id/revoke

Request:
```json
{
  "reason": "Device lost"
}
```

Response (200):
```json
{
  "success": true
}
```

### Device Authenticated Endpoints

#### GET /api/v1/devices/me

Response (200):
```json
{
  "device": {
    "id": "uuid",
    "storeId": "uuid",
    "storeName": "Main Branch",
    "deviceName": "POS-A7X9K2",
    "status": "active",
    "boundAt": "2026-02-13T10:00:00Z"
  }
}
```

#### GET /api/v1/devices/users

Response (200):
```json
{
  "users": [
    {
      "id": "uuid",
      "name": "Budi",
      "role": "manager",
      "lastLoginAt": "2026-02-14T08:30:00Z"
    }
  ]
}
```

#### POST /api/v1/auth/logout

Response (200):
```json
{
  "success": true
}
```

#### POST /api/v1/auth/switch-user

Request:
```json
{
  "userId": "uuid",
  "pin": "123456"
}
```

Response (200):
```json
{
  "user": {
    "id": "uuid",
    "name": "Sari",
    "role": "cashier",
    "storeId": "uuid"
  },
  "accessToken": "eyJhbG..."
}
```

## Offline Behavior

This feature does NOT require offline support since:
- Device binding requires server connectivity
- PIN authentication requires server connectivity
- Admin device management is web-only

## Security Implementation

### PIN Security

```typescript
// apps/api/src/utils/auth.ts

import bcrypt from 'bcrypt';

const SALT_ROUNDS = 10;

export async function hashPin(pin: string): Promise<string> {
  return bcrypt.hash(pin, SALT_ROUNDS);
}

export async function verifyPin(pin: string, hash: string): Promise<boolean> {
  return bcrypt.compare(pin, hash);
}

export function validatePinFormat(pin: string): boolean {
  return /^\d{6}$/.test(pin);
}
```

### Binding Code Generation

```typescript
// apps/api/src/utils/device.ts

const CODE_CHARS = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Exclude I, O, 0, 1

export function generateBindingCode(length: number = 6): string {
  const chars = CODE_CHARS;
  let code = '';
  const randomValues = crypto.getRandomValues(new Uint8Array(length));
  for (let i = 0; i < length; i++) {
    code += chars[randomValues[i] % chars.length];
  }
  return code;
}

export function generateDeviceName(): string {
  const id = generateBindingCode(5);
  return `POS-${id}`;
}
```

### Device Fingerprinting

```typescript
// apps/web/src/utils/deviceFingerprint.ts

export async function getDeviceFingerprint(): Promise<string> {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  ctx.textBaseline = 'top';
  ctx.font = '14px Arial';
  ctx.fillStyle = '#f60';
  ctx.fillRect(125, 1, 62, 20);
  ctx.fillStyle = '#069';
  ctx.fillText('Majumapan POS', 2, 15);
  ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
  ctx.fillText('Majumapan POS', 4, 17);
  
  const dataUrl = canvas.toDataURL();
  const hash = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(dataUrl));
  return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
}
```

### JWT Claims

```typescript
// Token payload
interface JwtPayload {
  userId: string;
  role: 'manager' | 'cashier';
  deviceId: string;
  storeId: string;
  type: 'access' | 'refresh';
  iat: number;
  exp: number;
}
```

## Implementation Tasks

| ID | Description | Phase | Files |
|----|-------------|-------|-------|
| T-01 | Create database migration for device_bindings and user_sessions tables | 1 | `apps/api/drizzle/*.sql` |
| T-02 | Update users and devices tables with new columns | 1 | `apps/api/drizzle/*.sql` |
| T-03 | Add DeviceBinding and UserSession types to shared package | 1 | `packages/shared/src/types.ts` |
| T-04 | Implement binding code and QR code generation utilities | 1 | `apps/api/src/utils/device.ts` |
| T-05 | Implement PIN hash/verify utilities | 1 | `apps/api/src/utils/auth.ts` |
| T-06 | Create device API endpoints (admin) | 1 | `apps/api/src/routes/admin/devices.ts` |
| T-07 | Create auth API endpoints (device-login, pin-login) | 1 | `apps/api/src/routes/auth.ts` |
| T-08 | Create device-authenticated endpoints | 1 | `apps/api/src/routes/devices.ts` |
| T-09 | Add device login screen component | 1 | `apps/web/src/components/auth/DeviceLoginScreen.tsx` |
| T-10 | Add QR scanner component | 1 | `apps/web/src/components/auth/QrScanner.tsx` |
| T-11 | Add user selection screen component | 2 | `apps/web/src/components/auth/UserSelectionScreen.tsx` |
| T-12 | Add PIN entry screen component | 2 | `apps/web/src/components/auth/PinEntryScreen.tsx` |
| T-13 | Create auth store with device/user state | 2 | `apps/web/src/stores/authStore.ts` |
| T-14 | Integrate device fingerprint utility | 1 | `apps/web/src/utils/deviceFingerprint.ts` |
| T-15 | Add device management pages to Admin Panel | 1 | `apps/admin/src/pages/Devices.tsx` |
| T-16 | Add user management with PIN to Admin Panel | 2 | `apps/admin/src/pages/Users.tsx` |
| T-17 | Implement session cleanup background job | 4 | `apps/api/src/jobs/sessionCleanup.ts` |
| T-18 | Implement device expiration background job | 4 | `apps/api/src/jobs/deviceExpiration.ts` |
| T-19 | Add user switch functionality | 3 | `apps/web/src/stores/authStore.ts` |
| T-20 | Integration testing | 5 | All components |

## Testing Strategy

| Test Case | Description |
|-----------|-------------|
| TC-01 | Admin creates device with valid store |
| TC-02 | Admin creates device with 24h expiration |
| TC-03 | Device binding code is 6-char unique |
| TC-04 | QR code contains correct binding data |
| TC-05 | Store Manager binds device via QR scan |
| TC-06 | Store Manager binds device via manual code entry |
| TC-07 | Invalid binding code shows error |
| TC-08 | Expired binding code shows error |
| TC-09 | Cashier logs in with correct PIN |
| TC-10 | Cashier fails PIN 5 times â†’ locked for 15 min |
| TC-11 | User switches to different user |
| TC-12 | Admin revokes device â†’ users logged out |
| TC-13 | Session expires after 30 min inactivity |
| TC-14 | JWT contains correct claims (userId, role, deviceId, storeId) |

## Files to Create

```
apps/api/src/
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ admin/
â”‚   â”‚   â””â”€â”€ devices.ts           # Device CRUD endpoints
â”‚   â”œâ”€â”€ auth.ts                   # Device login, PIN login
â”‚   â””â”€â”€ devices.ts                # Device-authenticated endpoints
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ device.ts                 # Code generation, QR generation
â”‚   â””â”€â”€ auth.ts                   # PIN hash/verify
â”œâ”€â”€ db/
â”‚   â””â”€â”€ schema.ts                 # Updated with device_bindings, user_sessions
â”œâ”€â”€ middleware/
â”‚   â””â”€â”€ deviceAuth.ts             # Device authentication middleware
â””â”€â”€ jobs/
    â”œâ”€â”€ sessionCleanup.ts         # Clean up inactive sessions
    â””â”€â”€ deviceExpiration.ts       # Expire unused binding codes

apps/api/drizzle/
â””â”€â”€ 000X_device_binding_auth.sql   # Migration file

apps/web/src/
â”œâ”€â”€ stores/
â”‚   â””â”€â”€ authStore.ts               # Auth state management
â”œâ”€â”€ components/
â”‚   â””â”€â”€ auth/
â”‚       â”œâ”€â”€ DeviceLoginScreen.tsx
â”‚       â”œâ”€â”€ QrScanner.tsx
â”‚       â”œâ”€â”€ UserSelectionScreen.tsx
â”‚       â””â”€â”€ PinEntryScreen.tsx
â”œâ”€â”€ pages/
â”‚   â””â”€â”€ Login.tsx                  # Updated to check device binding status
â””â”€â”€ utils/
    â””â”€â”€ deviceFingerprint.ts       # Browser fingerprinting

apps/admin/src/
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ Devices.tsx                # Device management page
â”‚   â””â”€â”€ Users.tsx                  # Updated with PIN management
â””â”€â”€ components/
    â””â”€â”€ devices/
        â”œâ”€â”€ DeviceList.tsx
        â”œâ”€â”€ CreateDeviceModal.tsx
        â””â”€â”€ DeviceDetailsPanel.tsx

packages/shared/src/
â””â”€â”€ types.ts                       # Updated with DeviceBinding, UserSession types

packages/api/src/
â””â”€â”€ apiClient.ts                   # Updated with device/auth methods
```

## Estimated Effort

| Phase | Focus | Time |
|-------|-------|------|
| Phase 1 | Database, API foundation, Device login | 8 hours |
| Phase 2 | User management, PIN auth, User selection | 8 hours |
| Phase 3 | PIN entry UI, User switch capability | 6 hours |
| Phase 4 | Session management, Revocation, Background jobs | 6 hours |
| Phase 5 | Security hardening, Testing, Polish | 6 hours |
| **Total** | | **~34 hours** |

## Dependencies

| Dependency | Description | Version |
|------------|-------------|---------|
| bcrypt | PIN hashing | ^5.x |
| jsonwebtoken | JWT generation | ^9.x |
| qrcode | QR code generation | ^1.5.x |
| html5-qrcode | QR code scanning | ^2.x |
| zod | Input validation | ^4.x |

## Related Documents

- **PRD**: [Device Binding Login System PRD](../prd/device-binding-login-system.md) - Product requirements, user personas, goals, success metrics
- **FSD**: [Shift Management](./shift-management.md) - Related to session management
- **FSD**: [Admin Panel](./admin-panel.md) - Admin Portal implementation
