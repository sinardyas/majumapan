# Product Requirements Document: Device Binding Login System

**Document Version:** 1.0  
**Last Updated:** 2026-02-14  
**Status:** Implemented  
**Related PRD:** Shift Management, User Management

---

## 1. Executive Summary

### 1.1 Overview

Implement a simplified POS login system using device binding via QR code or 6-character code. The system replaces email/password authentication with a two-step process:

1. **Device Binding** - Store Manager binds POS device to store using QR code or 6-character code (one-time setup)
2. **User Authentication** - Cashier/Store Manager selects their profile and enters 6-digit PIN to operate POS

Each POS device is bound to exactly one store (1:1 relationship), and each user belongs to exactly one store with a specific role (Manager or Cashier).

### 1.2 Goals

| Goal | Description |
|------|-------------|
| **Simplified Login** | Replace email/password with quick device binding + PIN |
| **Device Security** | Each device bound to one store, prevents unauthorized access |
| **User Accountability** | Every transaction traced to authenticated user (Manager/Cashier) |
| **Admin Control** | Admin can revoke device access remotely |
| **Audit Trail** | Complete logging of device bindings, logins, and revocations |

### 1.3 Key Design Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| **Login Methods** | QR Code Scan + 6-char Manual Entry | QR for speed, manual as backup |
| **PIN Length** | 6 digits | Balance between security and usability |
| **PIN Lockout** | 15 minutes after 5 failed attempts | Security without being overly punitive |
| **Shift Flow** | Separate from PIN login | Users start/end shifts independently |
| **User Avatar** | Initials only | Simpler, no photo management needed |
| **Profile Selection** | Tap to select (no quick numbers) | Clean UI, no number management |
| **Device Name** | Auto-generated by system | Consistent naming convention |
| **Binding Expiration** | 24 hours for unused codes | Security measure for unclaimed codes |

---

## 2. System Architecture

### 2.1 High-Level Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                 â”‚
â”‚  PHASE 1: Device Setup (One-time by Admin via Admin Portal)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Admin Portal                                                            â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ Select Store                                                       â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ Create Device â†’ System auto-generates:                             â”‚   â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ Device Name: "POS-[RandomID]" (e.g., POS-A7X9K2)             â”‚   â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ 6-char Code: "X7K9P2"                                        â”‚   â”‚
â”‚  â”‚  â”‚   â””â”€â”€ QR Code (contains code + store info)                         â”‚   â”‚
â”‚  â”‚  â””â”€â”€ Store Manager scans QR or enters code on POS device               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                            â”‚
â”‚                                      â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  PHASE 2: First-Time Device Login (Store Manager)                      â”‚   â”‚
â”‚  â”‚  POS Device Login Screen                                                â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ Option A: Scan QR Code                                             â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ Option B: Enter 6-char code manually                               â”‚   â”‚
â”‚  â”‚  â””â”€â”€ System validates â†’ Device bound to store (1:1 relationship)       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                            â”‚
â”‚                                      â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  PHASE 3: Daily POS Login (Cashier / Store Manager)                     â”‚   â”‚
â”‚  â”‚  POS Login Screen (after device is bound)                                â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ Shows: Store Name, Device Name, List of Users                     â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ User taps their profile                                            â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ PIN entry screen appears                                          â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ User enters 6-digit PIN                                            â”‚   â”‚
â”‚  â”‚  â””â”€â”€ Authenticated! â†’ Full POS access                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                            â”‚
â”‚                                      â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  PHASE 4: Admin Revocation (Anytime)                                    â”‚   â”‚
â”‚  â”‚  Admin Portal                                                           â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ Admin clicks "Revoke" on device                                    â”‚   â”‚
â”‚  â”‚  â””â”€â”€ POS device automatically logs out all users                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Entity Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                 â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚    â”‚  Store  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚     Device      â”‚                          â”‚
â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ 1:N                â”‚   Binding       â”‚                          â”‚
â”‚         â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚         â”‚ N:1                         â”‚ :1                                  â”‚
â”‚    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚    â”‚  Users  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ User Session â”‚                              â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 1:N                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                                                                 â”‚
â”‚    Store:                                                                   â”‚
â”‚    - One Store Manager (required)                                             â”‚
â”‚    - Multiple Cashiers (no limit)                                            â”‚
â”‚                                                                                 â”‚
â”‚    Device Binding:                                                            â”‚
â”‚    - Bound to ONE store                                                      â”‚
â”‚    - Has ONE active user session at a time                                   â”‚
â”‚                                                                                 â”‚
â”‚    User:                                                                      â”‚
â”‚    - Belongs to ONE store                                                    â”‚
â”‚    - Has ONE role (Manager or Cashier)                                       â”‚
â”‚    - Has ONE PIN for authentication                                          â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 User Role Comparison

| Feature | Store Manager | Cashier |
|---------|---------------|---------|
| Create new device | Own store only | âŒ No |
| Bind device to store | Own store only | âŒ No |
| Add/remove users | Own store only | âŒ No |
| Reset user PIN | Own store only | âŒ No |
| View all transactions | All | Own only |
| End of Day | âœ… Yes | âŒ No |
| Refund transactions | âœ… Yes | âš ï¸ Limited |
| Discount override | âœ… Yes | âš ï¸ Limited |
| Shift management | âœ… Yes | âŒ No |

---

## 3. Data Models

### 3.1 device_bindings Table

| Column | Type | Constraints | Description |
|--------|------|--------------|-------------|
| id | uuid | PK | Primary key |
| store_id | uuid | FK â†’ stores.id, NOT NULL | Associated store |
| device_id | uuid | FK â†’ devices.id, NULLABLE | Linked device (NULL until claimed) |
| binding_code | varchar(6) | UNIQUE, NOT NULL | 6-char alphanumeric code |
| qr_data | text | NOT NULL | JSON for QR generation |
| status | enum | `pending`, `active`, `revoked` | Binding status |
| device_name | varchar | NOT NULL | Auto-generated device name |
| device_fingerprint | text | NULLABLE | Browser/hardware hash |
| bound_at | timestamp | NULLABLE | When device was first claimed |
| expires_at | timestamp | NULLABLE | 24h from creation if unused |
| revoked_at | timestamp | NULLABLE | When revoked |
| revoked_by | uuid | FK â†’ users.id, NULLABLE | Who revoked |
| revoked_reason | text | NULLABLE | Reason for revocation |
| created_at | timestamp | NOT NULL, DEFAULT now() | Record creation |
| updated_at | timestamp | NOT NULL, DEFAULT now() | Last update |

### 3.2 user_sessions Table

| Column | Type | Constraints | Description |
|--------|------|--------------|-------------|
| id | uuid | PK | Primary key |
| user_id | uuid | FK â†’ users.id, NOT NULL | Authenticated user |
| device_id | uuid | FK â†’ devices.id, NOT NULL | Bound device |
| store_id | uuid | FK â†’ stores.id, NOT NULL | Store (redundant for query speed) |
| pin_hash | varchar | NOT NULL | bcrypt hashed PIN |
| is_active | boolean | NOT NULL, DEFAULT true | Current session flag |
| pin_failed_attempts | int | NOT NULL, DEFAULT 0 | Failed PIN attempts |
| pin_locked_until | timestamp | NULLABLE | Lockout expiration |
| last_active_at | timestamp | NULLABLE | For session timeout |
| last_pin_at | timestamp | NULLABLE | Last PIN validation |
| created_at | timestamp | NOT NULL, DEFAULT now() | Session start |
| ended_at | timestamp | NULLABLE | Session end |

### 3.3 users Table Updates

| Column | Type | Constraints | Description |
|--------|------|--------------|-------------|
| pin | varchar | NULLABLE | 6-digit PIN (bcrypt hashed, NULL = not set) |
| role | enum | `manager`, `cashier` | User role (admin excluded from POS) |
| store_id | uuid | FK â†’ stores.id, NOT NULL | Associated store |

### 3.4 devices Table Updates

| Column | Type | Constraints | Description |
|--------|------|--------------|-------------|
| binding_id | uuid | FK â†’ device_bindings.id, NULLABLE | Current binding |
| last_active_at | timestamp | NULLABLE | Last API call timestamp |
| is_master_terminal | boolean | NOT NULL, DEFAULT false | Master terminal status |

---

## 4. Functional Requirements

### 4.1 Admin Portal - Device Management

#### FR-001: Devices Menu (Sidebar Navigation)

**Location:** Admin Sidebar â†’ "Devices"

**Requirements:**
- Display all devices across all stores
- Filter by: Store dropdown, Status dropdown (All/Pending/Active/Revoked), Search by device name/code
- Sort by: Created At, Last Active, Status

#### FR-002: Create Device

**Access:** Devices Menu â†’ "Create Device" button OR Store â†’ Devices Tab â†’ "Create Device"

**Form Fields:**

| Field | Type | Description | Editable |
|-------|------|-------------|----------|
| Store | Dropdown | Select store | Admin: All stores, Manager: Own store only |
| Device Name | Auto-generated | Format: "POS-[RandomID]" (e.g., POS-A7X9K2) | Read-only |
| Binding Code | Auto-generated | 6-char alphanumeric (e.g., X7K9P2) | Read-only |
| Expiration | Dropdown | Never, 24 hours, 7 days, 30 days | Editable (default: 24h) |

**Actions:**
- Auto-generate device name and binding code on page load
- Show QR code preview after creation
- Allow copy of binding code
- Allow download of QR code as PNG

**Response:**
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "deviceName": "POS-A7X9K2",
    "bindingCode": "X7K9P2",
    "qrCode": "data:image/png;base64,...",
    "expiresAt": "2026-02-14T10:00:00Z"
  }
}
```

#### FR-003: Device List (All Devices View)

**Columns:**

| Column | Description |
|--------|-------------|
| Store | Store name (clickable to view store) |
| Device Name | Auto-generated name |
| Binding Code | 6-char code (masked with reveal option) |
| Status | Pending/Active/Revoked badge |
| Bound At | Timestamp (NULL if pending) |
| Last Active | Timestamp (NULL if never used) |
| Actions | View, Revoke, Regenerate Code |

**Actions:**

| Action | Behavior |
|--------|----------|
| **View** | Open device details panel |
| **Revoke** | Open confirmation modal â†’ Force logout all users |
| **Regenerate Code** | Generate new 6-char code (invalidates old) |

#### FR-004: Device Details

**Sections:**

| Section | Content |
|---------|---------|
| **Header** | Device name, ID, status badge |
| **Binding Info** | Store, Binding code, QR code, Created at, Expires at |
| **Activity** | Bound at, Last active at |
| **Session History** | List of user sessions with timestamps |
| **Actions** | Revoke, Regenerate Code, Download QR |

#### FR-005: Store â†’ Devices Tab âœ… IMPLEMENTED

**Location:** Stores â†’ [Store Name] â†’ Devices Tab

**Requirements:**
- Show only devices for that specific store âœ…
- Same columns as Devices Menu (minus Store column) âœ…
- Can create new devices for this store âœ…
- Can revoke/regenerate codes for these devices âœ…
- Can set device as master terminal (not implemented in v1)

**Implementation:**
- Admin Panel: `/stores/:id` route with Devices tab
- Store list: Click store name to navigate to detail page

---

### 4.2 Admin Portal - User Management Updates

#### FR-006: Create User

**Form Fields:**

| Field | Type | Validation |
|-------|------|------------|
| Name | Text | Required, max 100 chars |
| Email | Email | Unique, valid format |
| Role | Dropdown | Manager, Cashier |
| Store | Dropdown | Required |
| PIN | Text | 6 digits (optional, can be set later) |

**Manager Constraint:**
- If role = Manager and store already has a manager â†’ Show error: "Store already has a Manager. Please assign Cashier role or remove existing Manager first."

#### FR-007: Edit User

**Editable Fields:**
- Name
- Role (with manager constraint check)
- Store (with manager constraint check)

**Non-Editable:**
- Email (unique identifier)

#### FR-008: Reset PIN

**Actions:**
- Admin can clear PIN (user must set new PIN on next login)
- Admin can set temporary PIN (user forced to change on next login)

#### FR-009: User Session View

**Display:**
- Show user's current device (if logged in)
- Show last login timestamp
- Show session duration

---

### 4.3 POS - Device Login Flow

#### FR-010: Device Login (First Time / Unbound Device)

**Screen Layout:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Majumapan POS                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  [ ğŸ“· Scan QR Code ]     [ âŒ¨ï¸ Enter Code Manually ]     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚                                                                 â”‚
â”‚  QR SCAN MODE (default if camera available):                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚              [ Camera Viewfinder ]                      â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚              Point camera at QR code                    â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚           [ Switch to Manual Entry ]                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  MANUAL ENTRY MODE:                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚   Enter 6-character code:                              â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚   â”‚                                                 â”‚  â”‚   â”‚
â”‚  â”‚   â”‚           X  X  X  X  X  X                      â”‚  â”‚   â”‚
â”‚  â”‚   â”‚                                                 â”‚  â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚   [ Switch to QR Scan ]                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  [ Connect Device ]                                           â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Validation:**
- Binding code must be 6 characters, alphanumeric (case-insensitive)
- Code must exist and be in `pending` or `active` status
- Code must not be expired (if expires_at is set)
- Device fingerprint generated from browser/hardware

**Success Response:**
```json
{
  "success": true,
  "data": {
    "device": {
      "id": "uuid",
      "storeId": "uuid",
      "deviceName": "POS-A7X9K2",
      "storeName": "Main Branch"
    },
    "message": "Device successfully bound to Main Branch"
  }
}
```

**Failure Responses:**

| Error | Message | User Action |
|-------|---------|-------------|
| CODE_NOT_FOUND | "Invalid binding code. Please check and try again." | Verify code with admin |
| CODE_EXPIRED | "This binding code has expired. Please request a new code from admin." | Contact admin |
| CODE_ALREADY_USED | "This code has already been used to bind a device." | Use different code |
| DEVICE_ALREADY_BOUND | "This device is already bound to a store." | Unbind first or use different device |

---

#### FR-011: User Selection Screen

**Display Requirements:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Majumapan POS                     [Switch Device]      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  Store: Main Branch                                            â”‚
â”‚  Device: POS-A7X9K2                                           â”‚
â”‚                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚                                                                 â”‚
â”‚  Select Your Profile:                                          â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚   â”‚
â”‚  â”‚  â”‚  ğŸ‘¤ Budi    â”‚  Store Manager                           â”‚   â”‚
â”‚  â”‚  â”‚             â”‚  Last login: Today, 8:30 AM              â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚   â”‚
â”‚  â”‚  â”‚  ğŸ‘¤ Sari    â”‚  Cashier                                 â”‚   â”‚
â”‚  â”‚  â”‚             â”‚  Last login: Today, 9:15 AM              â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚   â”‚
â”‚  â”‚  â”‚  ğŸ‘¤ Jaya    â”‚  Cashier                                 â”‚   â”‚
â”‚  â”‚  â”‚             â”‚  Last login: Yesterday                   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Display Elements:**
- User avatar (circle with initials)
- User name
- Role label (Store Manager / Cashier)
- Last login timestamp (optional)
- Sorted by role (Manager first), then by name

**Interactions:**
- Tap/click user card â†’ Navigate to PIN entry screen
- "Switch Device" button â†’ Navigate to device login screen (for different store)

---

#### FR-012: PIN Entry Screen

**Display Requirements:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ‘¤ Budi                                                  â”‚   â”‚
â”‚  â”‚  Store Manager                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  Enter your PIN:                                               â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚           â—  â—  â—  â—  â—  â—                              â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”                                               â”‚
â”‚  â”‚ 1 â”‚ 2 â”‚ 3 â”‚                                               â”‚
â”‚  â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤                                               â”‚
â”‚  â”‚ 4 â”‚ 5 â”‚ 6 â”‚                                               â”‚
â”‚  â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤                                               â”‚
â”‚  â”‚ 7 â”‚ 8 â”‚ 9 â”‚                                               â”‚
â”‚  â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤                                               â”‚
â”‚  â”‚ â† â”‚ 0 â”‚ âœ“ â”‚                                               â”‚
â”‚  â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜                                               â”‚
â”‚                                                                 â”‚
â”‚  [Forgot PIN? Contact admin]                                   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Validation:**
- PIN must be exactly 6 digits
- PIN must match stored hash
- 5 failed attempts â†’ Lock account for 15 minutes

**Failure Responses:**

| Error | Message | Action |
|-------|---------|--------|
| INVALID_PIN | "Incorrect PIN. Attempts remaining: X" | Retry |
| PIN_LOCKED | "Account locked due to too many failed attempts. Try again in 15 minutes." | Wait |
| PIN_NOT_SET | "PIN not set. Please contact admin to set your PIN." | Contact admin |
| USER_INACTIVE | "Your account has been deactivated. Please contact admin." | Contact admin |

**Success:**
- Create/activate user session
- Store session in user_sessions table
- Generate JWT with userId, role, deviceId, storeId
- Redirect to POS dashboard

---

#### FR-013: Switch User

**Location:** POS Header â†’ User avatar â†’ "Switch User"

**Behavior:**
- Deactivate current user session (keep device bound)
- Navigate to user selection screen
- New user authenticates with PIN
- Previous user can log back in later

---

### 4.4 Session Management

#### FR-014: Session Timeout

**Rules:**
- 30 minutes of inactivity â†’ User session expires
- "Inactivity" = no API calls from POS device
- On timeout â†’ Show PIN entry screen (device remains bound)

#### FR-015: Admin Revoke Device

**Admin Action:**
1. Admin opens device details
2. Clicks "Revoke Access"
3. Confirms in modal (optional: enter reason)
4. Device status changes to `revoked`

**User Impact:**
- All active user sessions on that device immediately invalidated
- POS devices shows: "Device access revoked. Please contact admin."
- Users must request new device binding from admin

#### FR-016: Force Logout User

**Admin Action:**
1. Admin opens user details or device details
2. Finds active session
3. Clicks "Force Logout"
4. User session immediately invalidated

**User Impact:**
- User sees: "Your session has been ended by admin."
- Redirected to user selection screen

---

## 5. API Endpoints

### 5.1 Admin Endpoints (Require admin or manager role)

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/admin/devices` | List all devices (with filters) |
| POST | `/admin/devices` | Create new device |
| GET | `/admin/devices/:id` | Get device details |
| PUT | `/admin/devices/:id/revoke` | Revoke device access |
| PUT | `/admin/devices/:id/regenerate` | Regenerate binding code |
| GET | `/admin/devices/:id/qr-code` | Get QR code image |
| GET | `/admin/users/:id/sessions` | Get user's sessions |

### 5.2 Store-Scoped Endpoints (Manager role, own store only)

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/stores/:storeId/devices` | List devices for store |
| POST | `/stores/:storeId/devices` | Create device for store |
| PUT | `/stores/:storeId/devices/:id/revoke` | Revoke device for store |
| GET | `/stores/:storeId/users` | List users for store |
| POST | `/stores/:storeId/users` | Create user for store |
| PUT | `/stores/:storeId/users/:id` | Update user for store |
| PUT | `/stores/:storeId/users/:id/pin` | Reset user PIN |

### 5.3 Public Endpoints (No Authentication)

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/auth/device-login` | Login with binding code â†’ returns device + users |
| POST | `/auth/pin-login` | Authenticate user with PIN |

### 5.4 Device Authenticated Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/devices/me` | Get current device and binding status |
| GET | `/devices/users` | List users for this device's store |
| POST | `/auth/logout` | End user session |
| GET | `/auth/me` | Get current user info |
| POST | `/devices/switch-user` | Switch to different user (deactivates current) |

---

## 6. Security Requirements

### 6.1 PIN Security

| Requirement | Implementation |
|------------|----------------|
| **Hashing** | bcrypt with salt round 10 |
| **Length** | Exactly 6 digits |
| **Lockout** | 5 failed attempts â†’ 15 minute lockout |
| **Rate Limiting** | Max 10 PIN attempts per hour per user |
| **Cleartext** | Never stored or transmitted in plain text |

### 6.2 Binding Code Security

| Requirement | Implementation |
|------------|----------------|
| **Generation** | Cryptographically secure random |
| **Characters** | 6-char alphanumeric (exclude confusing: I, O, 0, 1) |
| **Uniqueness** | UNIQUE constraint in database |
| **Expiration** | Default 24 hours for unused codes |
| **Regeneration** | Invalidates old code immediately |

### 6.3 Device Fingerprinting

| Component | Description |
|-----------|-------------|
| User Agent | Browser identification |
| Screen Resolution | Screen dimensions |
| Timezone | Browser timezone |
| Hardware Concurrency | CPU cores |
| Canvas Fingerprint | Unique canvas rendering hash |

### 6.4 Session Security

| Requirement | Implementation |
|------------|----------------|
| **JWT Claims** | userId, role, deviceId, storeId |
| **Token Expiry** | 8 hours for access token |
| **Refresh Token** | 7 days, stored as bcrypt hash |
| **Device Binding** | JWT tied to specific deviceId |
| **Session Validation** | Middleware checks deviceId and userId match |

---

## 7. User Flows

### 7.1 Admin Creates Device Flow

```
1. Admin logs into Admin Portal
2. Navigates to Devices Menu or Store â†’ Devices Tab
3. Clicks "Create Device"
4. Selects Store (Manager: limited to own store)
5. Selects Expiration (default: 24 hours)
6. System auto-generates:
   - Device Name: "POS-A7X9K2"
   - Binding Code: "X7K9P2"
   - QR Code
7. Admin views/copies code or downloads QR
8. Admin shares code/QR with Store Manager
```

### 7.2 Store Manager Binds Device Flow

```
1. Manager opens POS app on new device
2. POS shows device login screen
3. Manager chooses method:
   Option A: Scan QR Code
   - Camera opens
   - Manager scans QR from admin portal
   Option B: Enter Code Manually
   - Manager types "X7K9P2"
4. System validates code
5. Device binds to store
6. POS shows "Device Setup Complete"
7. Manager taps "Continue" â†’ User selection screen
8. Manager selects their profile
9. Enters PIN â†’ Authenticated
10. POS dashboard loads
```

### 7.3 Cashier Daily Login Flow

```
1. Cashier opens POS app
2. POS shows user selection screen (device already bound)
3. Cashier taps their profile
4. PIN entry screen appears
5. Cashier enters 6-digit PIN
6. Authenticated
7. POS dashboard loads with cashier's permissions
```

4 Admin Revokes### 7. Device Flow

```
1. Admin opens Admin Portal
2. Navigates to Devices Menu
3. Finds target device
4. Clicks "Revoke"
5. Confirms in modal (optional: reason)
6. System updates status to "revoked"
7. All active sessions on device invalidated
8. POS devices show "Access Revoked" message
```

### 7.5 User Switch Flow

```
1. Authenticated Cashier is using POS
2. Cashier taps user avatar in header
3. Selects "Switch User"
4. Current session deactivated
5. User selection screen appears
6. New user selects profile
7. Enters PIN
8. New session activated
```

---

## 8. Error Handling

### 8.1 Admin Errors

| Error | Message | Resolution |
|-------|---------|------------|
| SECOND_MANAGER | "Store already has a Manager. Remove existing Manager first." | Contact admin |
| DEVICE_NOT_FOUND | "Device not found" | Verify device ID |
| DEVICE_ALREADY_BOUND | "Device is already bound to another store" | Unbind first |
| PERMISSION_DENIED | "You don't have permission to perform this action" | Check role |

### 8.2 POS Login Errors

| Error | Message | Resolution |
|-------|---------|------------|
| CODE_NOT_FOUND | "Invalid binding code. Please check and try again." | Verify code |
| CODE_EXPIRED | "This binding code has expired. Request a new code from admin." | Contact admin |
| CODE_ALREADY_USED | "This code has already been used." | Use different code |
| INVALID_PIN | "Incorrect PIN. Attempts remaining: X." | Retry |
| PIN_LOCKED | "Account locked for 15 minutes due to too many failed attempts." | Wait |
| PIN_NOT_SET | "PIN not set. Contact admin to set your PIN." | Contact admin |
| USER_INACTIVE | "Your account has been deactivated." | Contact admin |
| SESSION_REVOKED | "Your session has been ended by admin." | Re-authenticate |
| DEVICE_REVOKED | "Device access has been revoked. Please contact admin." | Contact admin |

### 8.3 Session Errors

| Error | Message | Resolution |
|-------|---------|------------|
| DEVICE_INACTIVE | "Device has been deactivated." | Contact admin |
| SESSION_TIMEOUT | "Session expired due to inactivity." | Re-authenticate |
| DEVICE_MISMATCH | "Device mismatch. Please log in again." | Re-authenticate |

---

## 9. Accessibility

### 9.1 Keyboard Navigation

| Key | Action |
|-----|--------|
| Tab | Navigate between fields |
| Enter/Return | Submit form |
| Escape | Cancel / Go back |
| Arrow Keys | Navigate user list |
| Numbers 0-9 | PIN entry |

### 9.2 Touch Targets

| Element | Minimum Size |
|---------|--------------|
| User profile cards | 64x64px |
| PIN input field | 48x48px |
| PIN keypad buttons | 48x48px |
| Action buttons | 44x44px |

### 9.3 Screen Readers

| Element | ARIA Label |
|---------|------------|
| User profile | "[Name], [Role]" |
| PIN input | "PIN entry, 6 digits" |
| Device status | "[Bound/Unbound/Revoked]" |

---

## 10. Integration Points

### 10.1 Related Components

| Component | Integration |
|-----------|-------------|
| **Admin Dashboard** | Device and user management pages |
| **POS Application** | Login flow, session management |
| **Auth Service** | JWT generation and validation |
| **Database** | Drizzle ORM for all tables |

### 10.2 Data Flow

```
Admin Portal                    POS Application
     â”‚                                â”‚
     â”œâ”€â”€ Create Device â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                               â”‚
     â”œâ”€â”€ View Devices â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€ User Selection
     â”‚                               â”‚
     â”œâ”€â”€ Revoke Device â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€ Session Validation
     â”‚                               â”‚
     â””â”€â”€ User Management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€ PIN Authentication
                                      â”‚
                                      â””â”€â”€ Session Creation
```

---

## 11. Background Jobs

### 11.1 Session Cleanup Job

**Schedule:** Every 5 minutes

**Actions:**
1. Mark inactive sessions (30 min no activity) as ended
2. Clean up expired device bindings (auto-delete after 30 days)
3. Clear expired PIN lockouts

### 11.2 Device Expiration Job

**Schedule:** Every hour

**Actions:**
1. Check pending bindings with expires_at < now()
2. Mark as expired
3. Send notification to admin (optional)

---

## 12. Testing Requirements

### 12.1 Unit Tests

| Test Case | Expected Result |
|-----------|-----------------|
| Generate binding code | 6-char alphanumeric, unique |
| Generate QR code | Valid QR image, contains code + storeId |
| Validate PIN | bcrypt compare returns correct result |
| Check manager constraint | Prevents second manager |
| Session timeout | User logged out after inactivity |
| Device binding | 1:1 relationship enforced |

### 12.2 Integration Tests

| Test Case | Expected Result |
|-----------|-----------------|
| Full device login flow | Device bound, users listed |
| Full PIN login flow | User authenticated, JWT issued |
| Admin revoke device | Users logged out, device shows revoked |
| User switch flow | Old session ended, new session started |

### 12.3 E2E Tests

| Test Case | Expected Result |
|-----------|-----------------|
| Admin creates device and binds POS | Device appears in admin, binds successfully |
| Cashier logs in, processes transaction | Transaction created with userId |
| Admin revokes during transaction | Transaction fails, user logged out |

---

## 13. Future Enhancements

### 13.1 Out of Scope (v1)

| Feature | Reason |
|---------|--------|
| WebSocket for real-time revocation | Polling sufficient for v1 |
| Bulk device creation | Manual creation acceptable |
| Device templates | Future consideration |
| SAML/SSO integration | Not required |

### 13.2 Future Considerations

| Feature | Description |
|---------|-------------|
| **WebSocket Revocation** | Instant logout instead of polling |
| **Biometric Authentication** | Fingerprint/Face ID for PIN replacement |
| **Bulk Device Provisioning** | Create multiple devices at once |
| **Device Templates** | Pre-configured device settings |
| **Device Groups** | Organize devices by location/type |
| **Audit Dashboard** | Visual session and device analytics |

---

## 14. Implementation Phases

| Phase | Duration | Deliverables |
|-------|----------|--------------|
| **Phase 1: Foundation** | 1 week | Schema, Code/QR generation, Admin device CRUD, POS device login |
| **Phase 2: User Management** | 1 week | User PIN storage, User sessions table, Admin user CRUD, Manager constraint |
| **Phase 3: PIN Login Flow** | 1 week | User selection UI, PIN authentication, User switch capability |
| **Phase 4: Session Management** | 5 days | Inactivity timeout, Admin revoke, Force logout, Background cleanup |
| **Phase 5: Security & Polish** | 5 days | Rate limiting, Audit logging, Error messages, Testing |

**Total: 5-6 weeks**

---

## 15. Document History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2026-02-13 | Initial draft |
| 1.1 | 2026-02-14 | Implementation complete - All phases implemented |
| 1.2 | 2026-02-14 | Added Store Detail page with Devices tab (FR-005) |

---

**Document End**
